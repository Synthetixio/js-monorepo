import { gql } from 'graphql-request';
import { RateUpdateQueryParams } from '../../src/types';
import { createGQLWhereString, createGQLBlockNumberString } from '../../src/utils';

export const createRateUpdatesQuery = ({
	synth,
	minTimestamp,
	autoGeneratedPaginationField,
	blockNumber,
}: RateUpdateQueryParams): string => {
	const whereString = createGQLWhereString(
		Object.entries({
			synth: synth != null ? 'synth' : null,
			timestamp_gte: minTimestamp != null ? 'minTimestamp' : null,
			timestamp_lt: autoGeneratedPaginationField != null ? 'autoGeneratedPaginationField' : null,
		})
	);

	return gql`
		query rateUpdates($autoGeneratedPaginationField: Int, $max: Int, $synth: String, $minTimestamp: Int) {
			rateUpdates(
				first: $max${createGQLBlockNumberString(blockNumber)}
				where: ${whereString}
				orderBy: timestamp
				orderDirection: desc
			) {
				id
				currencyKey
				synth
				rate
				block
				timestamp
			}
		}
	`;
};

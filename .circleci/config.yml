version: 2.1

orbs:
  browser-tools: circleci/browser-tools@1.4.0

parameters:
  node-version:
    type: string
    default: '16.17.0'

commands:
  yarn-install:
    steps:
      - restore_cache:
          keys:
            - node-modules-{{ .Environment.CACHE_VERSION }}-{{ checksum "yarn.lock" }}

      # yarn's state of installation
      - restore_cache:
          keys:
            - yarn-install-state-{{ .Environment.CACHE_VERSION }}-{{ checksum "yarn.lock" }}

      - run:
          name: yarn install
          command: |-
            # Check if we restored cache and have node_modules already
            if [ -f "node_modules/.yarn-state.yml" ] && [ -f ".yarn/install-state.gz" ]; then
              echo "node_modules restored from cache"
              exit 0
            else
              echo "node_modules could not be restored from cache, activating fallback installation"
              yarn install --immutable --immutable-cache
            fi

      - save_cache:
          key: node-modules-{{ .Environment.CACHE_VERSION }}-{{ checksum "yarn.lock" }}
          paths:
            - 'node_modules'

      - save_cache:
          key: yarn-install-state-{{ .Environment.CACHE_VERSION }}-{{ checksum "yarn.lock" }}
          paths:
            - '.yarn/install-state.gz'

  cypress-install:
    steps:
      - restore_cache:
          keys:
            - cypress-{{ .Environment.CACHE_VERSION }}-{{ checksum "node_modules/cypress/package.json" }}

      - run:
          name: cypress install
          working_directory: ~/app/v2/cypress
          command: |-
            # Check if we restored cache and have node_modules already
            if yarn cypress verify ; then
              echo "Cypress restored from cache"
              exit 0
            else
              echo "Cypress could not be restored from cache, activating fallback installation"
              CYPRESS_INSTALL_BINARY= yarn cypress install
            fi

      - save_cache:
          key: cypress-{{ .Environment.CACHE_VERSION }}-{{ checksum "node_modules/cypress/package.json" }}
          paths:
            - '~/cypress'

  tenderly-prepare:
    steps:
      - run:
          name: Prepare Tenderly fork
          command: |-
            ./node_modules/.bin/tenderly-fork | jq
            # Pick the first wallet
            WALLET_ADDRESS=$(./node_modules/.bin/tenderly-fork | jq -r '.simulation_fork.accounts | keys[0]')
            WALLET_MNEMONIC=$(./node_modules/.bin/tenderly-fork | jq -r '.simulation_fork.accounts | first(values[])')
            TENDERLY_FORK_ID=$(./node_modules/.bin/tenderly-fork | jq -r '.simulation_fork.id')

            ./node_modules/.bin/tenderly-getsnx $WALLET_ADDRESS

            echo 'export WALLET_ADDRESS="'$WALLET_ADDRESS'"' >> "$BASH_ENV"
            echo 'export WALLET_MNEMONIC="'$WALLET_MNEMONIC'"' >> "$BASH_ENV"
            echo 'export TENDERLY_RPC_URL="https://rpc.tenderly.co/fork/'$TENDERLY_FORK_ID'"' >> "$BASH_ENV"

            cat $BASH_ENV

  tenderly-cleanup:
    steps:
      - run:
          when: always
          name: Remove Tenderly fork
          command: |-
            ./node_modules/.bin/tenderly-unfork

  build-save:
    steps:
      - save_cache:
          key: build-{{ .Environment.CACHE_VERSION }}-{{ .Revision }}
          paths:
            - './contracts'
            - './packages'
            - './tools'
            - './v1'
            - './v2'
            - './v3'

  build-restore:
    steps:
      - restore_cache:
          keys:
            - build-{{ .Environment.CACHE_VERSION }}-{{ .Revision }}

jobs:
  yarn-install:
    working_directory: ~/app
    docker:
      - image: cimg/node:<< pipeline.parameters.node-version >>
    steps:
      - checkout

      # yarn's state of installation
      - restore_cache:
          keys:
            - yarn-install-state-{{ .Environment.CACHE_VERSION }}-{{ checksum "yarn.lock" }}

      # yarn's own state of node_modules
      - restore_cache:
          keys:
            - yarn-state-node-modules-{{ .Environment.CACHE_VERSION }}-{{ checksum "yarn.lock" }}

      - run:
          name: Halt if node_modules exist in cache
          command: |-
            # Check if we restored cache and have node_modules already
            if [ -f "node_modules/.yarn-state.yml" ]; then
              echo "SKIP, no changes detected"
              circleci-agent step halt
            fi

      #
      # Proceed with installing node modules, but to speed things up, restore caches
      #

      # Restore system-wide caches "~/.cache"
      - restore_cache:
          keys:
            - caches-{{ .Environment.CACHE_VERSION }}-{{ checksum "yarn.lock" }}
            - caches-{{ .Environment.CACHE_VERSION }}-

      # Restore yarn's project-specific caches ".yarn/cache"
      - restore_cache:
          keys:
            - yarn-cache-{{ .Environment.CACHE_VERSION }}-{{ checksum "yarn.lock" }}
            - yarn-cache-{{ .Environment.CACHE_VERSION }}-

      # node_modules cache
      - restore_cache:
          keys:
            - node-modules-{{ .Environment.CACHE_VERSION }}-{{ checksum "yarn.lock" }}

      - run: yarn install --immutable --immutable-cache

      - save_cache:
          key: node-modules-{{ .Environment.CACHE_VERSION }}-{{ checksum "yarn.lock" }}
          paths:
            - 'node_modules'

      - save_cache:
          key: caches-{{ .Environment.CACHE_VERSION }}-{{ checksum "yarn.lock" }}
          paths:
            - '~/.cache'

      - save_cache:
          key: yarn-cache-{{ .Environment.CACHE_VERSION }}-{{ checksum "yarn.lock" }}
          paths:
            - '.yarn/cache'

      - save_cache:
          key: yarn-install-state-{{ .Environment.CACHE_VERSION }}-{{ checksum "yarn.lock" }}
          paths:
            - '.yarn/install-state.gz'

      - save_cache:
          key: yarn-state-node-modules-{{ .Environment.CACHE_VERSION }}-{{ checksum "yarn.lock" }}
          paths:
            - 'node_modules/.yarn-state.yml'

  checks:
    working_directory: ~/app
    docker:
      - image: cimg/node:<< pipeline.parameters.node-version >>
    steps:
      - checkout
      - yarn-install
      - run: yarn npm audit --recursive --severity=critical
      - run: yarn deps
      - run: yarn deps:mismatched
      - run: yarn deps:circular
      - run: yarn pretty
      - run: yarn lint
      - run: yarn test

  build:
    working_directory: ~/app
    docker:
      - image: cimg/node:<< pipeline.parameters.node-version >>
    steps:
      - checkout
      - yarn-install
      - run: yarn build
      # codegen is part of build, so ensure we have all the autogenerated code committed
      - run: git diff --name-only --exit-code
      - build-save

  v2-e2e:
    working_directory: ~/app
    docker:
      - image: cimg/node:16.17.0-browsers
    resource_class: large
    environment:
      CYPRESS_CRASH_REPORTS: 0
      CYPRESS_INSTALL_BINARY: 0
      CYPRESS_CACHE_FOLDER: ~/cypress
    steps:
      - checkout
      - yarn-install
      - cypress-install
      - browser-tools/install-chrome
      - build-restore

      - run:
          name: Run server localhost:3000
          working_directory: ~/app/v2/out
          command: python3 -m http.server 3000
          background: true

      - tenderly-prepare
      - run: yarn workspace @snx-v2/cypress run e2e:check
      - tenderly-cleanup

      - run: yarn workspace @snx-v2/cypress run cy:check

  v2-cy:
    working_directory: ~/app
    docker:
      - image: cimg/node:16.17.0-browsers
    resource_class: large
    environment:
      CYPRESS_CRASH_REPORTS: 0
      CYPRESS_INSTALL_BINARY: 0
      CYPRESS_CACHE_FOLDER: ~/cypress
    steps:
      - checkout
      - yarn-install
      - cypress-install
      - browser-tools/install-chrome
      - build-restore

      - run: yarn workspace @snx-v2/cypress run cy:check

workflows:
  version: 2.1

  ui:
    jobs:
      - yarn-install
      - checks:
          requires: [yarn-install]
      - build:
          requires: [yarn-install]
      - v2-e2e:
          requires: [yarn-install, build]
      - v2-cy:
          requires: [yarn-install, build]
